<% layout("/layouts/boilerplate") -%>
<div class="row mt-3">
    <div class="col-8 offset-2">
        <h3>Edit your Listing</h3>
        <form id="editForm" method="POST" action="/listings/<%= listing._id %>?_method=PUT" class="needs-validation" novalidate enctype="multipart/form-data">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">

            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" name="listing[title]" value="<%= listing.title %>" class="form-control" required/>
                <div class="valid-feedback">Title looks good!</div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea type="text" name="listing[description]" class="form-control" required> <%= listing.description %> </textarea>
                <div class="invalid-feedback">Please enter a short description</div>
            </div>

            <% if (listing.images.length > 1) { %>
                <h5 class="text-danger mb-3">Delete selected images:</h5>
                <div class="mb-3">
                    <div class="d-flex justify-content-center">
                        <div id="carousel-container" style="position: relative; width: 600px; height: 400px;">
                            <img 
                                id="carousel-image"
                                data-images='<%= JSON.stringify(listing.images.map(img => ({ url: img.url, filename: img.filename }))) %>'
                                src="<%= listing.images[0].url %>"
                                data-filename="<%= listing.images[0].filename %>"
                                style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;"
                            />
                            <div class="position-absolute top-0 start-0 bg-dark bg-opacity-75 text-white rounded-pill px-3 py-1 mt-2 ms-2" style="font-size: 0.9rem;">
                            <label class="form-check-label d-flex align-items-center mb-0">
                                <span class="me-2">Do you want to delete this image:</span>
                                <input 
                                type="checkbox" 
                                id="deleteImageCheckbox" 
                                class="form-check-input"
                                />
                            </label>
                            </div>

                            <button id="prevBtn" type="button">&#8249;</button>
                            <button id="nextBtn" type="button">&#8250;</button>
                        </div>
                    </div>
                    <!-- Delete Selected Images Button -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-danger" id="openDeleteModal">Delete Selected Images</button>
                    </div>

                    <!-- Modal -->
                    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content border-danger">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
                                <button type="button" class="btn-close bg-light" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Do you really want to delete the selected images?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete & Save Changes</button>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } else { %> 
                <div class="text-center mb-4">
                    <img 
                        src="<%= listing.images[0].url %>" 
                        style="width: 600px; height: 400px; object-fit: cover; border-radius: 10px;"
                    />
                    <p class="text-danger mt-3 fw-bold">You can't delete the image as there is only one image left.</p>
                </div>
            <% } %>

            <div class="mb-3 mt-4">
                <label for="image" class="form-label">Add New Images</label>
                <input type="file" name="listing[images]" multiple class="form-control" accept="image/*">
                <div class="form-text">You can upload multiple images.</div>
            </div>


            <% if (listing.images.length > 1) { %>
                <div class="mb-4">
                    <button type="button" class="btn btn-outline-primary" id="toggleReorderBtn">
                        Reorder Images
                    </button>
                </div>

                <!-- Hidden reorder grid -->
                <div id="reorderBox" class="border p-3 rounded" style="display: none;">
                    <p class="fw-semibold mb-2">Drag and drop the images to reorder them:</p>
                    <div id="sortable-container" class="d-flex flex-wrap gap-3">
                        <% listing.images.forEach((img) => { %>
                            <div class="sortable-item" data-filename="<%= img.filename %>">
                                <img src="<%= img.url %>" class="img-thumbnail" style="width: 150px; height: 100px; object-fit: cover;" />
                            </div>
                        <% }) %>
                    </div>
                    <input type="hidden" name="imageOrder" id="imageOrderField" />
                </div>
            <% } %>


            <div class="row">
                <div class="mb-3 col-md-4">
                    <label for="price" class="form-label">Price</label>
                    <input type="number" name="listing[price]" value="<%= listing.price %>" class="form-control" required>
                    <div class="invalid-feedback">Price should be valid</div>
                </div>

                <div class="mb-3 col-md-8">
                    <label for="country" class="form-label">Country</label>
                    <input type="text" name="listing[country]" value="<%= listing.country %>" class="form-control" required>
                    <div class="invalid-feedback">Country name should be valid</div>
                </div>
            </div>

            <div class="mb-3">
                <label for="location" class="form-label">Location</label>
                <input type="text" name="listing[location]" value="<%= listing.location %>" class="form-control" required>
                <div class="invalid-feedback">Location should be valid</div>
            </div>

            <input type="hidden" name="deleteImages" id="deleteImagesField" />

            
            <button class="btn btn-dark edit-btn mt-3">Edit</button>
        </form>
    </div>
</div>

<script src="/js/carousel.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="/js/image-sort.js"></script>
